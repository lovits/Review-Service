# Review Service (ç”µå•†è¯„è®ºæœåŠ¡)

åŸºäº Kratos æ¡†æ¶å¼€å‘çš„å¾®æœåŠ¡ç”µå•†è¯„è®ºç³»ç»Ÿã€‚è¯¥æœåŠ¡è´Ÿè´£ç®¡ç†ç”¨æˆ·è¯„è®ºçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è¯„è®ºå‘å¸ƒã€è¿è¥å®¡æ ¸ã€å•†å®¶å›å¤ä»¥åŠå•†å®¶ç”³è¯‰å¤„ç†ã€‚ç³»ç»Ÿé‡‡ç”¨è¯»å†™åˆ†ç¦»æ¶æ„ï¼Œç»“åˆ Redis ç¼“å­˜å’Œ Elasticsearch æœç´¢ï¼Œä»¥æ”¯æŒé«˜æ€§èƒ½çš„æŸ¥è¯¢éœ€æ±‚ã€‚

## ğŸ“š é¡¹ç›®æ¦‚è¿°

review æœåŠ¡æ˜¯ç”µå•†å¹³å°çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œæ—¨åœ¨è¿æ¥ç”¨æˆ·ã€å•†å®¶å’Œè¿è¥äººå‘˜ï¼š
*   **ç”¨æˆ· (Cç«¯)**ï¼šå¯¹è´­ä¹°çš„å•†å“å’ŒæœåŠ¡è¿›è¡Œè¯„ä»·ï¼ˆè¯„åˆ†ã€å›¾æ–‡/è§†é¢‘ï¼‰ï¼Œå¹¶æ”¯æŒè¿½åŠ è¯„è®ºã€‚
*   **å•†å®¶ (Bç«¯)**ï¼šæŸ¥çœ‹åº—é“ºè¯„ä»·ï¼Œå›å¤ç”¨æˆ·è¯„è®ºï¼Œå¯¹æ¶æ„å·®è¯„å‘èµ·ç”³è¯‰ã€‚
*   **è¿è¥ (Oç«¯)**ï¼šåå°å®¡æ ¸ç”¨æˆ·å‘å¸ƒçš„è¯„è®ºï¼Œå¤„ç†å•†å®¶çš„ç”³è¯‰è¯·æ±‚ï¼Œç»´æŠ¤å¹³å°å†…å®¹è´¨é‡ã€‚

## ğŸ›  æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶ä¸è¯­è¨€
*   **Golang**: `1.23+`
*   **Framework**: [Kratos v2](https://github.com/go-kratos/kratos) - Bilibili å¼€æºçš„å¾®æœåŠ¡æ¡†æ¶
*   **API Protocol**: gRPC (å†…éƒ¨é€šä¿¡) & HTTP (ç½‘å…³æš´éœ²)
*   **Serialization**: Protocol Buffers

### æ•°æ®å­˜å‚¨ä¸ä¸­é—´ä»¶
*   **MySQL**: æ ¸å¿ƒä¸šåŠ¡æ•°æ®å­˜å‚¨ (Review, Reply, Appeal)ã€‚
*   **Elasticsearch**: æœç´¢å¼•æ“ï¼Œç”¨äºé«˜æ€§èƒ½çš„å¤æ‚æŸ¥è¯¢ï¼ˆå•†å®¶/ç”¨æˆ·ç»´åº¦çš„è¯„è®ºåˆ—è¡¨ï¼‰ã€‚
*   **Redis**: ç¼“å­˜å±‚ï¼ŒåŠ é€Ÿçƒ­ç‚¹æ•°æ®è¯»å–ã€‚

### æ ¸å¿ƒåº“ä¸å·¥å…·
*   **ORM**: [GORM](https://gorm.io/) + [GORM Gen](https://gorm.io/gen) (ç±»å‹å®‰å…¨çš„ SQL æ„å»º)ã€‚
*   **Dependency Injection**: [Google Wire](https://github.com/google/wire) (ç¼–è¯‘æœŸä¾èµ–æ³¨å…¥)ã€‚
*   **Service Discovery**: [Consul](https://www.consul.io/) (æœåŠ¡æ³¨å†Œä¸å‘ç°)ã€‚
*   **Concurrency Control**: `golang.org/x/sync/singleflight` (é˜²æ­¢ç¼“å­˜å‡»ç©¿)ã€‚
*   **ID Generator**: Snowflake (é›ªèŠ±ç®—æ³•ç”Ÿæˆåˆ†å¸ƒå¼ ID)ã€‚
*   **Validation**: `protoc-gen-validate` (å‚æ•°æ ¡éªŒ)ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. è¯„è®ºç®¡ç† (User Side)
*   **å‘å¸ƒè¯„è®º**: æ”¯æŒè¯„åˆ†ï¼ˆå•†å“/æœåŠ¡/å¿«é€’ï¼‰ã€æ–‡æœ¬å†…å®¹ã€ä¸Šä¼ å›¾ç‰‡/è§†é¢‘ã€‚
*   **è¿½åŠ è¯„è®º**: å¯¹åŒä¸€è®¢å•æ”¯æŒè¿½åŠ è¯„è®ºå†…å®¹ã€‚
*   **æŸ¥è¯¢è¯„è®º**: åˆ†é¡µè·å–ç”¨æˆ·ä¸ªäººçš„å†å²è¯„è®ºã€‚

### 2. å•†å®¶äº’åŠ¨ (Merchant Side)
*   **è¯„è®ºåˆ—è¡¨**: é«˜æ€§èƒ½æŸ¥è¯¢åº—é“ºä¸‹çš„æ‰€æœ‰è¯„è®ºï¼ˆåŸºäº ESï¼‰ã€‚
*   **å›å¤è¯„è®º**: å•†å®¶å¯ä»¥å¯¹ç”¨æˆ·è¯„è®ºè¿›è¡Œå›å¤ï¼ˆæ¯æ¡è¯„è®ºé™å›å¤ä¸€æ¬¡ï¼‰ã€‚
*   **ç”³è¯‰æœºåˆ¶**: é’ˆå¯¹ä¸å®æˆ–æ¶æ„è¯„è®ºå‘èµ·ç”³è¯‰ï¼Œå¡«å†™ç”³è¯‰ç†ç”±åŠä¸¾è¯ææ–™ã€‚

### 3. è¿è¥å®¡æ ¸ (Operation Side)
*   **è¯„è®ºå®¡æ ¸**: å®¡æ ¸ç”¨æˆ·æ–°å‘å¸ƒçš„è¯„è®ºï¼ˆå‘å¸ƒ -> å¾…å®¡æ ¸ -> å·²å‘å¸ƒ/é©³å›ï¼‰ã€‚
*   **ç”³è¯‰å®¡æ ¸**: å®¡æ ¸å•†å®¶çš„ç”³è¯‰è¯·æ±‚ã€‚è‹¥ç”³è¯‰é€šè¿‡ï¼Œç›¸å…³è¯„è®ºå°†è‡ªåŠ¨éšè—æˆ–æ ‡è®°ã€‚

### 4. é«˜çº§ç‰¹æ€§
*   **è¯»å†™åˆ†ç¦»**: å†™å…¥æ“ä½œç›´æ¥è½åº“ MySQLï¼›è¯»å–æ“ä½œä¼˜å…ˆæŸ¥ Redisï¼Œæœªå‘½ä¸­æŸ¥ ESã€‚
*   **é˜²ç¼“å­˜å‡»ç©¿**: ä½¿ç”¨ Singleflight åˆå¹¶å¹¶å‘è¯·æ±‚ï¼Œä¿æŠ¤åç«¯å­˜å‚¨ã€‚
*   **çŠ¶æ€æœºç®¡ç†**: ä¸¥æ ¼çš„è¯„è®ºä¸ç”³è¯‰çŠ¶æ€æµè½¬é€»è¾‘ã€‚

## ğŸ— ç³»ç»Ÿæ¶æ„

### ç›®å½•ç»“æ„
éµå¾ª Kratos æ ‡å‡†å¸ƒå±€ (Layout)ï¼š

```
review/
â”œâ”€â”€ api/             # Protocol Buffers å®šä¹‰ (gRPC/HTTP æ¥å£)
â”‚   â”œâ”€â”€ business/    # Bç«¯æ¥å£
â”‚   â”œâ”€â”€ operation/   # è¿è¥ç«¯æ¥å£
â”‚   â””â”€â”€ review/      # æ ¸å¿ƒè¯„è®ºæ¥å£
â”œâ”€â”€ cmd/             # ç¨‹åºå…¥å£ (main.go, wireä¾èµ–æ³¨å…¥)
â”œâ”€â”€ configs/         # é…ç½®æ–‡ä»¶ (config.yaml, registry.yaml)
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ biz/         # ä¸šåŠ¡é€»è¾‘å±‚ (UseCase, Domain Object)
â”‚   â”œâ”€â”€ data/        # æ•°æ®è®¿é—®å±‚ (Repository, MySQL/ES/Redis å®ç°)
â”‚   â”œâ”€â”€ service/     # æ¥å£å®ç°å±‚ (DTO è½¬æ¢, è°ƒç”¨ biz)
â”‚   â”œâ”€â”€ server/      # HTTP/gRPC Server é…ç½®
â”‚   â””â”€â”€ conf/        # é…ç½®ç»“æ„ä½“å®šä¹‰ (.proto)
â”œâ”€â”€ pkg/             # å…¬å…±åŒ… (snowflake ç­‰)
â””â”€â”€ third_party/     # ç¬¬ä¸‰æ–¹ proto æ–‡ä»¶
```

### çŠ¶æ€æµè½¬å›¾

**è¯„è®ºç”Ÿå‘½å‘¨æœŸ:**
```mermaid
graph LR
    User[ç”¨æˆ·å‘è¡¨] --> Pending[10-å¾…å®¡æ ¸]
    Pending -->|è¿è¥å®¡æ ¸é€šè¿‡| Published[20-å·²å‘å¸ƒ]
    Pending -->|è¿è¥é©³å›| Rejected[30-é©³å›]
    
    Published -->|å•†å®¶ç”³è¯‰æˆåŠŸ| Hidden[40-ç”³è¯‰é€šè¿‡/éšè—]
```

**ç”³è¯‰ç”Ÿå‘½å‘¨æœŸ:**
```mermaid
graph LR
    Merchant[å•†å®¶ç”³è¯‰] --> AppealPending[10-å¾…å®¡æ ¸]
    AppealPending -->|è¿è¥é€šè¿‡| AppealPass[20-ç”³è¯‰é€šè¿‡]
    AppealPending -->|è¿è¥é©³å›| AppealReject[30-ç”³è¯‰é©³å›]
    
    AppealPass -.->|è§¦å‘| UpdateReview[æ›´æ–°è¯„è®ºçŠ¶æ€ä¸º40]
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚
*   Go 1.23+
*   Docker & Docker Compose
*   Consul (æœåŠ¡å‘ç°)
*   MySQL, Redis, Elasticsearch

### æœ¬åœ°è¿è¡Œ

1.  **å¯åŠ¨ä¾èµ–ç¯å¢ƒ**
    ä½¿ç”¨æ ¹ç›®å½•æˆ–é¡¹ç›®ç›®å½•ä¸‹çš„ `docker-compose.yaml` å¯åŠ¨åŸºç¡€è®¾æ–½ï¼š
    ```bash
    docker-compose up -d
    ```

2.  **åˆå§‹åŒ–æ•°æ®åº“**
    æ‰§è¡Œ review.sql è„šæœ¬åˆå§‹åŒ– MySQL è¡¨ç»“æ„ã€‚

3.  **ç”Ÿæˆä»£ç ** (å¦‚æœ‰ä¿®æ”¹ proto æˆ– wire)
    ```bash
    make api   # ç”Ÿæˆ proto ä»£ç 
    make wire  # ç”Ÿæˆä¾èµ–æ³¨å…¥ä»£ç 
    ```

4.  **è¿è¡ŒæœåŠ¡**
    ```bash
    # ä¸‹è½½ä¾èµ–
    go mod tidy
    
    # è¿è¡Œ
    kratos run
    ```

### é…ç½®æ–‡ä»¶
ä¿®æ”¹ config.yaml ä»¥åŒ¹é…ä½ çš„æœ¬åœ°ç¯å¢ƒï¼š
```yaml
data:
  database:
    driver: mysql
    source: root:password@tcp(127.0.0.1:3306)/reviewdb...
  redis:
    addr: 127.0.0.1:6379
  elasticsearch:
    addresses: ["http://127.0.0.1:9200"]
```

## ğŸ“ API æ¦‚è§ˆ

| Method | URI | Description |
| :--- | :--- | :--- |
| `POST` | `/v1/review` | åˆ›å»ºè¯„è®º (ç”¨æˆ·) |
| `GET` | `/v1/review/{reviewID}` | è·å–è¯„è®ºè¯¦æƒ… |
| `POST` | `/v1/review/reply` | å›å¤è¯„è®º (å•†å®¶) |
| `POST` | `/v1/review/appeal` | ç”³è¯‰è¯„è®º (å•†å®¶) |
| `POST` | `/v1/review/audit` | å®¡æ ¸è¯„è®º (è¿è¥) |
| `POST` | `/v1/appeal/audit` | å®¡æ ¸ç”³è¯‰ (è¿è¥) |
| `GET` | `/v1/review/store/{storeID}` | è·å–åº—é“ºè¯„è®ºåˆ—è¡¨ (ESæœç´¢) |
| `GET` | `/v1/review/user/{userID}` | è·å–ç”¨æˆ·è¯„è®ºåˆ—è¡¨ (ESæœç´¢) |
